---
- name: Quick Deploy WB Project Manager
  hosts: production
  gather_facts: false

  tasks:
    - name: Pull latest code
      raw: "cd {{ app_dir }} && git fetch origin && git reset --hard origin/{{ git_branch }}"

    - name: Rebuild and restart
      raw: "cd {{ app_dir }} && docker compose -f {{ compose_file }} up -d --build --force-recreate 2>&1 | tail -20"

    - name: Wait for services
      raw: sleep 20

    - name: Health check
      raw: |
        HTTP_CODE=$(curl -s -o /dev/null -w '%{http_code}' http://127.0.0.1:{{ app_port }}/api/health)
        echo "Health check: $HTTP_CODE"
        if [ "$HTTP_CODE" = "200" ]; then
          echo "Quick deploy successful!"
        else
          echo "WARNING: Health check returned $HTTP_CODE"
          docker logs wb-project-manager --tail 30
        fi
      changed_when: false
