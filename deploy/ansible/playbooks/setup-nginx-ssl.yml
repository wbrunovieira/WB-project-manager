---
- name: Setup Nginx + SSL for WB Project Manager
  hosts: production
  gather_facts: false

  tasks:
    # ── Phase 1: HTTP-only config for Certbot ──────────────
    - name: Create Nginx HTTP config
      raw: |
        cat > /etc/nginx/sites-available/{{ app_domain }} << 'NGINX'
        server {
            listen 80;
            server_name {{ app_domain }};

            location / {
                proxy_pass http://127.0.0.1:{{ app_port }};
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }
        }
        NGINX

    - name: Enable site
      raw: |
        ln -sf /etc/nginx/sites-available/{{ app_domain }} /etc/nginx/sites-enabled/
        nginx -t && systemctl reload nginx

    # ── Phase 2: SSL with Certbot ──────────────────────────
    - name: Obtain SSL certificate
      raw: "certbot --nginx -d {{ app_domain }} --non-interactive --agree-tos -m {{ certbot_email }}"

    # ── Phase 3: Rewrite config with Authelia ──────────────
    - name: Rewrite Nginx config with HTTPS + Authelia
      raw: |
        cat > /etc/nginx/sites-available/{{ app_domain }} << 'NGINX'
        server {
            listen 80;
            server_name {{ app_domain }};
            return 301 https://$server_name$request_uri;
        }

        server {
            listen 443 ssl;
            server_name {{ app_domain }};

            ssl_certificate /etc/letsencrypt/live/{{ app_domain }}/fullchain.pem;
            ssl_certificate_key /etc/letsencrypt/live/{{ app_domain }}/privkey.pem;
            include /etc/letsencrypt/options-ssl-nginx.conf;
            ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

            # Authelia verification endpoint
            include /etc/nginx/snippets/authelia-location.conf;

            # API routes - bypass Authelia (uses own Bearer token auth)
            location /api/ {
                proxy_pass http://127.0.0.1:{{ app_port }};
                proxy_http_version 1.1;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }

            # Next.js static files - bypass Authelia
            location /_next/static/ {
                proxy_pass http://127.0.0.1:{{ app_port }};
                proxy_http_version 1.1;
                proxy_set_header Host $host;
            }

            location /_next/image {
                proxy_pass http://127.0.0.1:{{ app_port }};
                proxy_http_version 1.1;
                proxy_set_header Host $host;
            }

            location /favicon.ico {
                proxy_pass http://127.0.0.1:{{ app_port }};
            }

            # Frontend routes - protected by Authelia
            location / {
                include /etc/nginx/snippets/authelia-authrequest.conf;

                proxy_pass http://127.0.0.1:{{ app_port }};
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }
        }
        NGINX

    - name: Test and reload Nginx
      raw: "nginx -t && systemctl reload nginx"

    # ── Phase 4: Verify ───────────────────────────────────
    - name: Verify HTTPS
      raw: |
        echo "Frontend (expect 302 Authelia redirect):"
        curl -s -o /dev/null -w '%{http_code}' https://{{ app_domain }}
        echo ""
        echo "API health (expect 200):"
        curl -s -o /dev/null -w '%{http_code}' https://{{ app_domain }}/api/health
        echo ""
      changed_when: false
